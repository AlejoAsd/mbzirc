name: integration_tests

on: [push]

jobs:
  integration_tests:
    runs-on: ubuntu-20.04 # linux required if you want to use docker
    steps:
      - name: Check out code
        uses: actions/checkout@v2
        #      - name: Install and run xvfb
        #run: |
        #  sudo apt-get install -y xvfb
        #  Xvfb :1 -ac -noreset -core -screen 0 1280x1024x24 &
      - name: Build base image
        run: docker build -t mbzirc_sim . -f docker/tests/Dockerfile
      - name: compile ign-rendering without MESA_GL_VERSION_OVERRIDE
        run: |
          docker run \
              mbzirc_sim /bin/bash -c \
                'Xvfb :1 -ac -noreset -core -screen 0 1280x1024x24 & \
                 export DISPLAY=:1.0 \
                 && export RENDER_ENGINE_VALUES=ogre2 \
                 && git clone https://github.com/ignitionrobotics/ign-rendering -b ign-rendering6 \
                 && cd ign-rendering \
                 && mkdir build \
                 && cd build \
                 && cmake .. \
                 && make -j3 INTEGRATION_camera \
                 && make test ARGS="-VV -R INTEGRATION_camera"'
      - name: compile ign-rendering with xvfb-run
        run: |
          docker run \
              mbzirc_sim /bin/bash -c \
                'xvfb-run --auto-servernum --server-num=1 --server-args="-screen 0 1280x1024x24" \
                 && export DISPLAY=:1.0 \
                 && export RENDER_ENGINE_VALUES=ogre2 \
                 && export MESA_GL_VERSION_OVERRIDE=3.3 \
                 && git clone https://github.com/ignitionrobotics/ign-rendering -b ign-rendering6 \
                 && cd ign-rendering \
                 && mkdir build \
                 && cd build \
                 && cmake .. \
                 && make -j3 INTEGRATION_camera \
                 && make test ARGS="-VV -R INTEGRATION_camera"'
      - name: Run tests
        run: |
          docker run \
              mbzirc_sim /bin/bash -c \
                'Xvfb :1 -ac -noreset -core -screen 0 1280x1024x24 & \
                 export DISPLAY=:1.0 \
                 && export RENDER_ENGINE_VALUES=ogre2 \
                 && source /home/$USERNAME/mbzirc_ws/install/setup.bash \
                 && colcon test --merge-install \
                             --event-handlers console_direct+ \
                             --packages-select mbzirc_ros \
                 && colcon test-result'
      # && export MESA_GL_VERSION_OVERRIDE=3.3 \
